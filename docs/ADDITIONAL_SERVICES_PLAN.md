# План реализации: Таможня, Доставка до двери и Страхование груза

## Обзор задачи
Разработать логику расчета стоимости и отображения для трех дополнительных услуг при создании заявки:
1. **Таможенное оформление** (Customs Clearance)
2. **Доставка до двери** (Door-to-Door Delivery)
3. **Страхование груза** (Cargo Insurance)

---

## КАК УСЛУГИ ОСУЩЕСТВЛЯЮТСЯ: Роль платформы Vector Express

### Бизнес-модель платформы

**Vector Express = Агрегатор логистических услуг (маркетплейс перевозчиков)**

Платформа НЕ владеет:
- Грузовиками
- Самолетами
- Складами
- Таможенными лицензиями
- Страховыми полисами

**Платформа СОЕДИНЯЕТ:**
- Клиентов (грузоотправителей)
- Перевозчиков (DHL, FedEx, UPS, PonyExpress, местные компании)
- Таможенных брокеров (партнеры с лицензиями)
- Страховые компании (партнеры)

**Модель заработка:** Комиссия 5% с каждой сделки

---

## ДЕТАЛЬНОЕ ОПИСАНИЕ: Как работает каждая услуга

### 1. ТАМОЖЕННОЕ ОФОРМЛЕНИЕ - Как это работает?

#### Что происходит в реальности:

**Шаг 1: Клиент создает заявку на платформе**
```
Клиент на сайте:
☑ Включает опцию "Таможенное оформление"
→ Система добавляет +$150 к стоимости
→ В заказе статус: customs_clearance = true
```

**Шаг 2: Платформа передает заказ перевозчику + таможенному брокеру**
```
Vector Express автоматически:
1. Отправляет данные груза лицензированному брокеру (партнер)
2. Брокер получает уведомление: "Новый груз на таможню"
3. Передает данные: invoice, packing list, описание груза, ТН ВЭД код
```

**Шаг 3: Таможенный брокер делает всю работу**
```
Таможенный брокер (НЕ Vector Express):
✓ Заполняет декларацию в системе Астана-1 (электронная система РК)
✓ Загружает сканы документов (инвойс, контракт, сертификаты)
✓ Рассчитывает пошлины и НДС
✓ Подает декларацию в таможню
✓ Оплачивает сборы (от имени клиента, деньги списываются с баланса)
✓ Получает разрешение на выпуск груза
✓ Отправляет документы клиенту и перевозчику
```

**Шаг 4: Платформа отслеживает статус**
```
Vector Express мониторит:
- Статус декларации (подана → проверяется → одобрена)
- Сроки (обещали 12-36 часов)
- Отправляет уведомления клиенту: "Груз проходит таможню", "Таможня пройдена"
```

**Шаг 5: Финансы**
```
Клиент платит Vector Express:     $150 (услуга брокера)
                                  +$XXX (пошлины и НДС - реальная сумма)

Vector Express платит брокеру:     $142.50 (95% от $150)
Vector Express оставляет себе:     $7.50 (5% комиссия)

Пошлины/НДС транзитом:            $XXX → государству (без комиссии)
```

#### Роль Vector Express в таможне:

| Что делает платформа | Что НЕ делает платформа |
|---------------------|------------------------|
| ✅ Собирает данные от клиента (инвойс, ТН ВЭД) | ❌ Не заполняет декларацию сама |
| ✅ Передает данные брокеру автоматически | ❌ Не имеет таможенной лицензии |
| ✅ Отслеживает статус таможни через API брокера | ❌ Не общается с таможней напрямую |
| ✅ Собирает деньги и оплачивает брокера | ❌ Не хранит товары на складе |
| ✅ Уведомляет клиента о статусе | ❌ Не несет ответственность за задержки таможни |

#### Партнеры для таможни:

**Казахстан:**
- [MLG](https://mlg.kz/) - таможенный брокер в Алматы
- [ICS Logistics](https://alaics.kz/) - полный спектр услуг
- [Optimustrans](https://www.optimustrans.com/) - ЕАЭС специализация

**Договор с брокером:**
- Минимальная ставка: $100-150 за декларацию
- Срок: 12-36 часов гарантированно
- API интеграция: статусы в реальном времени
- Оплата: Net 7 после выпуска груза

---

### 2. ДОСТАВКА ДО ДВЕРИ - Как это работает?

#### Что происходит в реальности:

**Шаг 1: Клиент включает опцию на платформе**
```
Клиент на сайте:
☑ Доставка до двери
→ Вводит точный адрес отправителя: ул. Пушкина, д. 5, кв. 10
→ Вводит точный адрес получателя: ул. Ленина, д. 20, офис 301
→ Система определяет: жилой/коммерческий, удаленная зона?
→ Добавляет +$16-49 к стоимости
```

**Шаг 2: Платформа передает задачу перевозчику**
```
Vector Express отправляет перевозчику:
- Адрес забора груза (с координатами, если есть)
- Желаемое время забора (выбирает клиент)
- Адрес доставки получателя
- Тип адреса: residential или commercial
- Инструкции: "Позвонить за 30 мин", "Домофон 25#"
```

**Шаг 3: Забор груза от отправителя (Door Pickup)**
```
Курьер перевозчика (DHL/FedEx/местная компания):
✓ Приезжает по адресу отправителя
✓ Звонит клиенту за 30 минут (если указано)
✓ Забирает груз, упакованный и готовый
✓ Выдает накладную (tracking number)
✓ Фотографирует груз (для подтверждения состояния)
✓ Загружает в машину → едет на склад/сортировочный центр
```

**Шаг 4: Основная перевозка (не входит в door-to-door)**
```
Груз транспортируется:
- Воздух: самолетом в аэропорт назначения
- Авто: грузовиком по трассе
- Море: контейнер на корабле
- ЖД: вагоном

Это БАЗОВАЯ перевозка (оплачивается отдельно, не door-to-door)
```

**Шаг 5: Доставка до адреса получателя (Door Delivery)**
```
Курьер в городе получателя:
✓ Забирает груз со склада/терминала
✓ Звонит получателю: "Доставка сегодня с 14:00 до 18:00"
✓ Приезжает по адресу
✓ Поднимает груз на этаж (если жилой адрес)
✓ Получает подпись получателя
✓ Фото доказательство доставки (POD - Proof of Delivery)
✓ Статус в системе → "Доставлено"
```

**Шаг 6: Платформа контролирует процесс**
```
Vector Express отслеживает:
- Курьер выехал на забор → уведомление клиенту
- Груз забран → SMS/email с tracking
- Груз на складе → статус "В пути"
- Курьер выехал на доставку → уведомление получателю
- Доставлено → закрытие заказа
```

**Финансы:**
```
Клиент платит Vector Express:     $24 (забор $8 + доставка $8 + residential $8)

Vector Express платит перевозчику: $22.80 (95% от $24)
Vector Express оставляет себе:     $1.20 (5% комиссия)
```

#### Роль Vector Express в door-to-door:

| Что делает платформа | Что НЕ делает платформа |
|---------------------|------------------------|
| ✅ Собирает адреса и инструкции от клиента | ❌ Не отправляет своих курьеров |
| ✅ Передает задачу перевозчику через API | ❌ Не владеет грузовиками |
| ✅ Определяет тип адреса и зону | ❌ Не поднимает груз на этаж сама |
| ✅ Отслеживает GPS курьера (если есть API) | ❌ Не несет ответственность за опоздания курьера |
| ✅ Уведомляет обе стороны о статусе | ❌ Не хранит груз на своих складах |

#### Технология определения типа адреса:

**Автоматическое определение:**
```javascript
function detectAddressType(address, postalCode) {
    // Ключевые слова коммерческих адресов
    const commercialKeywords = [
        'офис', 'office', 'бизнес центр', 'БЦ', 'TC', 'ТЦ',
        'склад', 'warehouse', 'завод', 'factory'
    ]

    // Проверка адреса
    if (commercialKeywords.some(keyword => address.includes(keyword))) {
        return 'commercial' // НЕТ residential surcharge
    }

    // Ключевые слова жилых адресов
    const residentialKeywords = [
        'кв.', 'квартира', 'apt', 'дом', 'house', 'коттедж'
    ]

    if (residentialKeywords.some(keyword => address.includes(keyword))) {
        return 'residential' // ЕСТЬ residential surcharge +$8
    }

    // По умолчанию residential (безопаснее)
    return 'residential'
}
```

**Проверка удаленной зоны:**
```javascript
// Таблица remote area postal codes в БД
const remoteAreas = await db.query(`
    SELECT postal_code_prefix
    FROM carrier_zone_postal_codes
    WHERE is_remote_area = true
`)

// Примеры для Казахстана:
// Turkestan: 161xxx
// Uralsk: 090xxx
// Semey: 071xxx

if (postalCode.startsWith('161') || postalCode.startsWith('090')) {
    surcharge += 25 // Remote area fee
}
```

---

### 3. СТРАХОВАНИЕ ГРУЗА - Как это работает?

#### Что происходит в реальности:

**Шаг 1: Клиент выбирает страхование**
```
Клиент на сайте:
☑ Страхование груза
→ Вводит заявленную стоимость: $10,000 USD
→ Видит расчет: тариф 0.5%, стоимость $50, франшиза $50
→ Соглашается с условиями
```

**Шаг 2: Платформа оформляет полис через страховую компанию**
```
Vector Express отправляет в страховую (партнер):
- Данные груза: тип, вес, объем, описание
- Маршрут: откуда → куда
- Транспорт: воздух/море/авто/ЖД
- Заявленная стоимость: $10,000
- Тип покрытия: All Risks (все риски)

Страховая компания:
✓ Проверяет данные (автоматически через API)
✓ Рассчитывает премию: $10,000 × 0.5% = $50
✓ Выпускает электронный полис (PDF)
✓ Полис действует на весь маршрут (от двери до двери)
✓ Отправляет полис на email клиента и в систему Vector Express
```

**Шаг 3: Перевозка с покрытием**
```
Во время перевозки груз застрахован от:
✓ Повреждение при погрузке/разгрузке
✓ ДТП на дороге
✓ Пожар, наводнение, стихийное бедствие
✓ Кража, грабеж (при определенных условиях)
✓ Авиакатастрофа, крушение корабля
✓ Утеря груза перевозчиком

НЕ покрывается (стандартные исключения):
✗ Недостаточная упаковка (вина клиента)
✗ Скрытые дефекты товара
✗ Война, теракт (нужно доп. покрытие)
✗ Естественная порча (для скоропортящихся товаров без рефрижератора)
```

**Шаг 4: Если произошел страховой случай**
```
Клиент обнаружил повреждение:
1. Фиксирует повреждение при получении груза
   → Фото/видео поврежденного груза
   → Подпись в накладной: "Груз поврежден"
   → Акт о повреждении от перевозчика

2. Подает заявку в Vector Express через платформу:
   → Форма "Страховой случай"
   → Загружает фото, акт, инвойс
   → Указывает сумму ущерба

3. Vector Express передает в страховую компанию:
   → Пакет документов
   → Номер полиса
   → Tracking груза (доказательство перевозки)

4. Страховая компания рассматривает (7-14 дней):
   → Проверяет документы
   → Может запросить экспертизу
   → Одобряет или отклоняет

5. Выплата компенсации:
   → Если одобрено: выплата на счет клиента
   → Сумма = ущерб - франшиза ($50)
   → Пример: ущерб $200 → выплата $150
```

**Финансы:**
```
Клиент платит Vector Express:     $50 (страховая премия)

Vector Express платит страховой:   $47.50 (95% от $50)
Vector Express оставляет себе:     $2.50 (5% комиссия)

При страховом случае:
Страховая платит клиенту:          до $10,000 (минус франшиза)
Vector Express НЕ ПЛАТИТ из своего кармана (это делает страховая)
```

#### Роль Vector Express в страховании:

| Что делает платформа | Что НЕ делает платформа |
|---------------------|------------------------|
| ✅ Оформляет полис через партнера-страховую | ❌ Не выдает полисы от своего имени |
| ✅ Собирает данные груза и рассчитывает премию | ❌ Не имеет страховой лицензии |
| ✅ Отправляет полис клиенту | ❌ Не проводит экспертизу повреждений |
| ✅ Помогает с подачей заявки на выплату | ❌ Не платит компенсацию из своих денег |
| ✅ Контролирует сроки рассмотрения | ❌ Не принимает финальное решение по выплате |

#### Партнеры для страхования:

**Казахстан:**
- [Halyk Insurance](https://halykinsurance.kz/) - крупнейшая страховая РК
- [Nomad Insurance](https://nomad.kz/) - специализация на грузах
- Международные: AIG, Zurich (для дорогих грузов >$100k)

**Договор со страховой:**
- Рамочный договор: Vector Express = агент
- Тарифы: 0.12% (ЕАЭС), 0.24-0.5% (международные)
- Лимит покрытия: до $100,000 на один груз
- Франшиза: 0.5% безусловная (или 0% за доп. плату)
- API интеграция: мгновенное оформление полисов
- Выплаты: 7-14 дней на рассмотрение

---

## ИНТЕГРАЦИИ: Какие API нужны платформе

### 1. API Таможенных брокеров
```
GET /customs/status/{declaration_id}
Response: {
    "status": "approved" | "pending" | "rejected",
    "declaration_number": "KZ12345678",
    "duties_amount": 5000,
    "processing_time": "24 hours"
}

POST /customs/submit
Request: {
    "invoice": "file.pdf",
    "packing_list": "file.pdf",
    "tn_ved_code": "8471300000",
    "declared_value": 10000
}
```

### 2. API Перевозчиков (для door-to-door)
```
POST /pickup/schedule
Request: {
    "address": "Алматы, ул. Пушкина 5",
    "date": "2025-12-20",
    "time_window": "10:00-14:00",
    "contact_phone": "+77001234567"
}

GET /courier/tracking/{pickup_id}
Response: {
    "status": "picked_up" | "on_way" | "delivered",
    "courier_name": "Иван Петров",
    "gps_location": {"lat": 43.25, "lng": 76.92}
}
```

### 3. API Страховых компаний
```
POST /policy/create
Request: {
    "cargo_description": "Electronics",
    "declared_value": 10000,
    "route": "Almaty → Moscow",
    "transport_type": "air"
}
Response: {
    "policy_number": "POL-2025-12345",
    "premium": 50,
    "coverage": "all_risks",
    "policy_pdf_url": "https://..."
}

POST /claim/submit
Request: {
    "policy_number": "POL-2025-12345",
    "damage_description": "Box crushed",
    "damage_photos": ["url1", "url2"],
    "damage_amount": 500
}
```

---

## ТАБЛИЦА: Кто что делает

| Услуга | Vector Express делает | Партнер делает | Клиент делает |
|--------|---------------------|----------------|---------------|
| **Таможня** | Собирает данные, передает брокеру, отслеживает статус, оплачивает | Заполняет декларацию, подает в таможню, получает разрешение | Предоставляет инвойс, контракт, описание груза |
| **Door-to-Door** | Собирает адреса, определяет тип, отправляет задачу курьеру, отслеживает GPS | Забирает груз, везет, доставляет до адреса, получает подпись | Готовит груз к забору, встречает курьера |
| **Страхование** | Оформляет полис, рассчитывает премию, отправляет клиенту, помогает с claims | Выдает полис, покрывает риски, рассматривает заявки, выплачивает компенсацию | Платит премию, фиксирует повреждения, подает claim |

---

## ВАЖНО: Ответственность и риски

### Что НЕ является ответственностью Vector Express:

1. **Таможня:**
   - ❌ Задержки таможни из-за проверок (это государство)
   - ❌ Доплата пошлин, если товар дороже заявленного
   - ❌ Запрет на ввоз определенных товаров

2. **Door-to-Door:**
   - ❌ Опоздание курьера из-за пробок/погоды
   - ❌ Невозможность доставки (клиент не дома, нет доступа)
   - ❌ Повреждение груза курьером (это покрывает страховка)

3. **Страхование:**
   - ❌ Отказ страховой в выплате (если клиент нарушил условия)
   - ❌ Занижение суммы компенсации экспертом
   - ❌ Долгое рассмотрение (более 14 дней)

### Что ЯВЛЯЕТСЯ ответственностью Vector Express:

1. **Общее:**
   - ✅ Корректный расчет стоимости услуг
   - ✅ Передача данных партнерам без ошибок
   - ✅ Своевременные уведомления клиенту
   - ✅ Поддержка клиентов 24/7 (чат, email, телефон)

2. **Финансы:**
   - ✅ Прозрачность цен (без скрытых комиссий)
   - ✅ Своевременная оплата партнерам
   - ✅ Возврат денег, если услуга не оказана

## Анализ конкурентов и рынка

### Казахстанские и СНГ стандарты

#### 1. Таможенное оформление (Customs Clearance)

**Стоимость по рынку Казахстана:**
- Минимальная стоимость: **43,000 тенге** (~$95 USD) за декларацию "под ключ"
- Услуги брокера от: **15,000 тенге** (~$33 USD) за 2 часа
- Срок оформления: **12-36 часов**
- **Обязательно**: Иностранные компании не могут работать с таможней напрямую - требуется лицензированный брокер

**Текущая реализация в Vector Express:**
- Фиксированная стоимость: **$150 USD**
- Применяется: при `customs_clearance=true`
- Источник: MockCarrierService

**Международные аналоги:**
- Порог беспошлинного ввоза в Казахстан: **€200** (31 кг)
- Декларация требуется в течение **30 дней** после прибытия товара
- Ставки НДС и пошлины в Казахстане ниже, чем в России

**Источники:**
- [MLG Customs Clearance](https://mlg.kz/)
- [ICS Logistics Almaty](https://alaics.kz/customs)
- [Kazakhstan Import Requirements - Trade.gov](https://www.trade.gov/country-commercial-guides/kazakhstan-import-requirements-and-documentation)

---

#### 2. Доставка до двери (Door-to-Door)

**Стоимость по рынку:**
- **UPS Residential Surcharge:** $4.80 USD
- **FedEx Residential Surcharge:** $3.80-$4.70 USD
- **DHL Kazakhstan:** входит в базовый тариф или фиксированная надбавка
- **Текущая реализация:** $8 USD фиксированная надбавка (residential_delivery)

**Компоненты door-to-door:**
- Забор груза от отправителя (door pickup)
- Доставка до адреса получателя (door delivery)
- Residential surcharge (если адрес жилой, а не коммерческий)
- Remote area surcharge (если район удаленный)

**Существующие надбавки в Vector Express:**
- Residential Delivery: **$8** (flat fee)
- Remote Area Surcharge: **$25** (для Turkestan, Uralsk, Semey)

**Источники:**
- [DHL Kazakhstan Service Guide 2024 (PDF)](https://mydhl.express.dhl/content/dam/downloads/kz/en/rate-guide/service_and_rate_guide_kz_en_2024.pdf.coredownload.pdf)
- [Easyship Residential Surcharges](https://support.easyship.com/hc/en-us/articles/19234635721362-Understanding-Residential-Address-Surcharges)
- [DocShipper US-Kazakhstan Freight](https://docshipper.us/en/freight-shipping-us-kazakhstan/)

---

#### 3. Страхование груза (Cargo Insurance)

**Тарифы по рынку СНГ:**
- **Базовый тариф:** 0.10% - 0.50% от заявленной стоимости
- **Средний тариф:** 0.14% - 0.15% от стоимости груза
- **ЕАЭС (внутри союза):** от 0.12% для грузов > 50,000 руб
- **Международные перевозки:** от 0.24% от стоимости
- **Ликвидные товары** (электроника, драгметаллы, алкоголь): +15-20% к тарифу

**Текущая реализация в Vector Express:**
- Тариф страхования: **0.5%** от declared_value
- Применяется: при `insurance_required=true` AND `declared_value` > 0
- Пример: $10,000 груз × 0.5% = $50

**Факторы влияющие на тариф:**
- Маршрут и расстояние
- Количество перегрузок
- Тип транспорта (воздух, море, ж/д, авто)
- Характеристики груза (хрупкость, ликвидность, стоимость)
- Франшиза (безусловная: 0.5% от стоимости груза)

**Источники:**
- [ATI.SU Cargo Insurance Calculator](https://ati.su/landings/insurances/)
- [Cargo Broker Tariffs](http://www.cargobroker.ru/service/cargo-insurance/terms/rates)
- [Galaxy Insurance Rates](https://galaxyinsurance.ru/services/usluga-1/)
- [Dellin Insurance](https://www.dellin.ru/insurance/cargo/)

---

## Рекомендации по реализации

### 1. Таможенное оформление

**Логика расчета:**
```
IF customs_clearance = true:
    IF shipment is_international = true:
        customs_fee = DYNAMIC CALCULATION:
            - Базовая ставка: $100-$200 (зависит от перевозчика)
            - Для ЕАЭС стран (KZ, RU, BY, KG, AM): $100
            - Для других стран: $150-$200
            - Дополнительно: время оформления 12-36 часов
    ELSE:
        customs_fee = 0 (не требуется для внутренних перевозок)
```

**Что включает услуга:**
- Подготовка таможенной декларации
- Оплата таможенных пошлин и сборов (транзит клиенту)
- Взаимодействие с таможенными органами
- Получение разрешительных документов
- Таможенный представитель (обязательно для иностранных компаний в КZ)

**Отображение в интерфейсе:**
```
☑ Таможенное оформление
  ├─ Базовая стоимость: $150
  ├─ Срок оформления: 12-36 часов
  └─ Включает: декларацию, взаимодействие с таможней, документы

  ⚠ Таможенные пошлины и НДС оплачиваются отдельно
```

---

### 2. Доставка до двери (Door-to-Door)

**Логика расчета:**
```
IF door_to_door = true:
    door_fee = BASE_PICKUP_FEE + BASE_DELIVERY_FEE

    BASE_PICKUP_FEE = $5-$10 (зависит от города/зоны)
    BASE_DELIVERY_FEE = $5-$10

    IF delivery_address_type = "residential":
        door_fee += RESIDENTIAL_SURCHARGE ($8)

    IF delivery_postal_code IN remote_areas:
        door_fee += REMOTE_AREA_SURCHARGE ($25)

    TOTAL_DOOR_FEE = door_fee
```

**Компоненты:**
- **Door Pickup** (забор груза): $5-$10
- **Door Delivery** (доставка до адреса): $5-$10
- **Residential Surcharge** (жилой адрес): $8
- **Remote Area Surcharge** (удаленная зона): $25

**Отображение в интерфейсе:**
```
☑ Доставка до двери
  ├─ Забор груза от отправителя: $8
  ├─ Доставка до адреса получателя: $8
  ├─ Надбавка за жилой адрес: $8 (если применимо)
  └─ Удаленная зона: $25 (если применимо)

  Итого: $16-$49 в зависимости от адреса
```

**Улучшения:**
- Автоматическое определение типа адреса (residential vs commercial)
- Проверка почтового индекса на принадлежность к remote area
- Разные тарифы для разных городов/стран

---

### 3. Страхование груза

**Логика расчета:**
```
IF insurance_required = true AND declared_value > 0:
    insurance_rate = DYNAMIC_RATE_CALCULATION:
        base_rate = 0.5% (по умолчанию)

        // Корректировка по типу груза
        IF cargo_type = "dangerous":
            base_rate += 0.1% (итого 0.6%)
        IF cargo_type = "fragile":
            base_rate += 0.05% (итого 0.55%)

        // Корректировка по маршруту
        IF route IS domestic (within Kazakhstan):
            base_rate = 0.12%
        ELSE IF route IS EAEU (KZ, RU, BY, KG, AM):
            base_rate = 0.12%
        ELSE IF route IS international:
            base_rate = 0.24-0.5%

        // Корректировка по ликвидности товара
        IF cargo IS high_liquidity (electronics, precious metals, etc):
            base_rate *= 1.2 (увеличение на 20%)

    insurance_cost = declared_value × (insurance_rate / 100)

    // Франшиза
    deductible = declared_value × 0.005 (0.5% безусловная франшиза)
```

**Отображение в интерфейсе:**
```
☑ Страхование груза
  ├─ Заявленная стоимость: $10,000
  ├─ Тариф: 0.5% (международная перевозка)
  ├─ Стоимость страховки: $50
  └─ Франшиза: $50 (0.5% от стоимости)

  Покрытие: все риски при перевозке
  Компенсация: до $10,000 за вычетом франшизы
```

**Типы покрытия:**
- "All Risks" (все риски): стандартное покрытие
- "Named Perils" (указанные риски): базовое покрытие (дешевле)
- "Total Loss Only" (только полная гибель): минимальное покрытие

**Улучшения:**
- Разные тарифы для разных типов грузов
- Настройка франшизы (0%, 0.5%, 1%, 2%)
- Опциональное покрытие войн, забастовок, терактов (+0.1-0.3%)

---

## Изменения в коде

### Backend файлы для модификации:

1. **Модель Shipment**
   - Путь: `/backend/app/Models/Shipment.php`
   - Изменения: добавить поля для детальной информации о услугах

2. **AbstractCarrierService**
   - Путь: `/backend/app/Services/Carriers/AbstractCarrierService.php`
   - Изменения:
     - Улучшить `calculateInsurance()` с динамическими тарифами
     - Добавить `calculateDoorToDoorfee()` с логикой residential/remote
     - Улучшить `calculateCustomsFee()` с проверкой ЕАЭС/международных

3. **MockCarrierService**
   - Путь: `/backend/app/Services/Carriers/MockCarrierService.php`
   - Изменения: реализовать новые формулы расчета

4. **Database migrations**
   - Добавить поля в таблицы:
     - `carrier_pricing_rules`: добавить `insurance_rate_domestic`, `insurance_rate_eaeu`, `insurance_rate_international`
     - `shipments`: добавить `address_type` (residential/commercial), `is_remote_area`

### Frontend файлы для модификации:

1. **ShipmentCreateView.vue**
   - Путь: `/frontend/src/views/shipments/ShipmentCreateView.vue`
   - Изменения:
     - Шаг 3: улучшить раздел "Дополнительные услуги"
     - Добавить поле ввода declared_value с валидацией
     - Показывать расчетную стоимость каждой услуги в реальном времени
     - Добавить подсказки/tooltips с объяснением

2. **ShipmentQuotesView.vue**
   - Путь: `/frontend/src/views/shipments/ShipmentQuotesView.vue`
   - Изменения:
     - Детализировать отображение door-to-door (pickup + delivery + surcharges)
     - Показывать расчет страхования (тариф, франшиза, покрытие)
     - Показывать детали таможни (срок, что включено)

3. **i18n переводы**
   - Файлы: `/frontend/src/i18n/locales/ru.json`, `en.json`, `kk.json`
   - Добавить переводы для новых терминов

### Новые компоненты (опционально):

1. **InsuranceCalculator.vue** - калькулятор страхования в реальном времени
2. **ServiceTooltip.vue** - переиспользуемый компонент подсказок

---

## Примерный UX флоу

### Шаг 3: Дополнительные услуги (улучшенная версия)

```
┌─────────────────────────────────────────────────────────┐
│ Дополнительные услуги                                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│ ☑ Страхование груза                          [+$50]     │
│   ┌────────────────────────────────────────────┐        │
│   │ Заявленная стоимость: [______] USD   ⓘ    │        │
│   │                                            │        │
│   │ Тариф: 0.5% (международная перевозка)     │        │
│   │ Стоимость: $50                             │        │
│   │ Франшиза: $50 (0.5%)                       │        │
│   └────────────────────────────────────────────┘        │
│                                                          │
│ ☑ Таможенное оформление                      [+$150]    │
│   ┌────────────────────────────────────────────┐        │
│   │ ✓ Таможенная декларация                    │        │
│   │ ✓ Взаимодействие с таможней                │        │
│   │ ✓ Разрешительные документы                 │        │
│   │                                            │        │
│   │ Срок: 12-36 часов                          │        │
│   │ ⚠ Пошлины и НДС оплачиваются отдельно     │        │
│   └────────────────────────────────────────────┘        │
│                                                          │
│ ☑ Доставка до двери                          [+$24]     │
│   ┌────────────────────────────────────────────┐        │
│   │ ✓ Забор от отправителя: $8                 │        │
│   │ ✓ Доставка до адреса: $8                   │        │
│   │ ✓ Надбавка жилой адрес: $8                 │        │
│   │                                            │        │
│   │ Адрес получателя:                          │        │
│   │ ( ) Коммерческий  (•) Жилой                │        │
│   └────────────────────────────────────────────┘        │
│                                                          │
│ Итого дополнительные услуги:             $224           │
│                                                          │
│         [Назад]              [Рассчитать стоимость]     │
└─────────────────────────────────────────────────────────┘
```

---

## Валидация и бизнес-правила

### Таможня:
- Применяется только для международных перевозок
- Внутренние перевозки внутри Казахстана: customs_fee = 0
- ЕАЭС (KZ ↔ RU, BY, KG, AM): упрощенная таможня, $100
- Остальные страны: полная таможня, $150-$200

### Страхование:
- Требуется declared_value > 0
- Максимальная страховая сумма: $100,000 (или лимит перевозчика)
- Минимальная страховая премия: $10
- Тариф зависит от: cargo_type, route, carrier

### Door-to-Door:
- Автоматически применять residential surcharge для жилых адресов
- Проверка remote area по таблице postal codes
- Разные тарифы для разных стран/городов

---

## Приоритет реализации

**Фаза 1 (MVP):**
1. ✅ Таможня: фиксированная стоимость $150 (уже реализовано)
2. ✅ Door-to-door: фиксированная $8 (уже реализовано)
3. ✅ Страхование: 0.5% от declared_value (уже реализовано)

**Фаза 2 (Улучшения):**
1. Динамический расчет таможни (ЕАЭС vs международная)
2. Детализация door-to-door (pickup + delivery + surcharges)
3. Тарифы страхования по типу груза и маршруту
4. Улучшенный UI с расчетом в реальном времени

**Фаза 3 (Продвинутые фичи):**
1. Интеграция с реальными страховыми компаниями
2. API таможенных брокеров
3. Автоматическое определение residential/commercial адресов
4. Remote area detection по координатам/индексам

---

## Источники и референсы

### Документация проекта:
- `/docs/CARRIER_PRICING_SYSTEM.md` - формулы ценообразования (920 строк)
- `/docs/LOGISTICS_PRICING_RESEARCH.md` - исследование логистического рынка (496 строк)
- `PRODUCT_FLOW_PLAN.md` - полный бизнес-флоу продукта

### Казахстанские аналоги:
- [MLG Таможенное оформление](https://mlg.kz/)
- [ICS Logistics Almaty](https://alaics.kz/customs)
- [DELLA.kz](https://www.della.kz/)
- [RTD Kazakhstan](https://rtd.com.kz/tarif.html)

### СНГ/России аналоги:
- [ATI.SU - Страхование грузов](https://ati.su/landings/insurances/)
- [Деловые Линии - Door-to-door](https://www.dellin.ru/ltl/door-to-door/)
- [Карго Брокер - Тарифы страхования](http://www.cargobroker.ru/service/cargo-insurance/terms/rates)

### Международные стандарты:
- [DHL Kazakhstan Service Guide 2024](https://mydhl.express.dhl/content/dam/downloads/kz/en/rate-guide/service_and_rate_guide_kz_en_2024.pdf.coredownload.pdf)
- [Kazakhstan Import Requirements - Trade.gov](https://www.trade.gov/country-commercial-guides/kazakhstan-import-requirements-and-documentation)
- [Easyship Residential Surcharges](https://support.easyship.com/hc/en-us/articles/19234635721362-Understanding-Residential-Address-Surcharges)

---

## Итоговая формула полной стоимости

```
TOTAL_SHIPMENT_PRICE =
    BASE_RATE
    + SURCHARGES (fuel, oversize, dangerous goods, etc.)
    + [CUSTOMS_FEE if customs_clearance=true]
    + [INSURANCE_COST if insurance_required=true]
    + [DOOR_TO_DOOR_FEE if door_to_door=true]
        └─ includes: pickup + delivery + residential + remote_area

Где:
- BASE_RATE: зависит от веса, зоны, перевозчика
- CUSTOMS_FEE: $100-$200 (ЕАЭС vs международная)
- INSURANCE_COST: declared_value × (0.12%-0.5%)
- DOOR_TO_DOOR_FEE: $16-$49 (pickup $8 + delivery $8 + surcharges)
```

### Пример расчета (Almaty → Moscow, 50kg, $10,000 declared value):

```
Base Rate:              $250.00   (50kg × $5/kg × zone multiplier)
Fuel Surcharge (15.5%): $38.75
Door-to-Door:           $16.00    (pickup $8 + delivery $8)
Insurance (0.12% ЕАЭС): $12.00    ($10,000 × 0.12%)
Customs (ЕАЭС):         $100.00   (упрощенная таможня)
─────────────────────────────────
TOTAL:                  $416.75 USD
```
